#!/usr/bin/env node

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

console.log('ğŸ”„ ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒãƒªã‚»ãƒƒãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹...');

try {
  // 1. å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
  console.log('ğŸ›‘ å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢ä¸­...');
  try {
    // npm run dev ã‚„ npm start ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
    execSync('pkill -f "next dev"', { stdio: 'ignore' });
    execSync('pkill -f "next start"', { stdio: 'ignore' });
    console.log('âœ… å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢ã—ã¾ã—ãŸ');
  } catch (error) {
    console.log('â„¹ï¸ åœæ­¢ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
  }
  
  // 2. Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å†ç”Ÿæˆ
  console.log('ğŸ“¦ Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å†ç”Ÿæˆä¸­...');
  execSync('npx prisma generate', { stdio: 'inherit' });
  
  // 3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
  console.log('ğŸ§¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ä¸­...');
  
  // .nextãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å‰Šé™¤
  const nextDir = path.join(process.cwd(), '.next');
  if (fs.existsSync(nextDir)) {
    fs.rmSync(nextDir, { recursive: true, force: true });
    console.log('âœ… .nextãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  }
  
  // node_modules/.cacheãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å‰Šé™¤
  const cacheDir = path.join(process.cwd(), 'node_modules', '.cache');
  if (fs.existsSync(cacheDir)) {
    fs.rmSync(cacheDir, { recursive: true, force: true });
    console.log('âœ… node_modules/.cacheãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  }
  
  // 4. ä¾å­˜é–¢ä¿‚ã®å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  console.log('ğŸ“¥ ä¾å­˜é–¢ä¿‚ã‚’å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­...');
  execSync('npm install', { stdio: 'inherit' });
  
  // 5. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
  console.log('ğŸš€ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­...');
  console.log('ğŸ“ ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„:');
  console.log('   curl -X POST http://localhost:3000/api/setup-master-data');
  console.log('');
  console.log('ğŸ“ ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ãã ã•ã„:');
  console.log('   npm run dev');
  
  console.log('ğŸ‰ ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒãƒªã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
  
} catch (error) {
  console.error('âŒ ãƒªã‚»ãƒƒãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error.message);
  process.exit(1);
} 